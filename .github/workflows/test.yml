# YYC³ AI小语智能成长守护系统 - 测试流水线
# @file test.yml
# @description 完整的测试工作流配置，包括单元测试、集成测试和覆盖率检查
# @author YYC³团队 <admin@0379.email>
# @version 1.1.0
name: YYC³ AI小语 - 测试工作流

on:
  push:
    branches: [ main, develop, 'fix/*', 'feature/*' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: 运行测试套件
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18, 20]

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: 安装依赖
      run: bun install --frozen-lockfile

    - name: 运行类型检查
      run: bun run tsc --noEmit

    - name: 运行 ESLint
      run: bun run lint

    - name: 运行测试并生成覆盖率报告
      run: bun run test:ci --coverage --reporter=json > coverage-report.json
    - name: 上传测试覆盖率报告
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage-report.json
    - name: 测试覆盖率质量门检查
      run: |
        COVERAGE=$(jq '.total.lines.pct' coverage-report.json || echo 0)
        echo "当前测试覆盖率: ${COVERAGE}%"
        if (( $(echo "$COVERAGE < 80" | bc -l) )); then
          echo "错误: 测试覆盖率低于80%的最低要求!"
          exit 1
        fi
        echo "✅ 测试覆盖率符合要求!"

    - name: 上传覆盖率报告
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  build:
    name: 构建测试
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: 安装依赖
      run: bun install --frozen-lockfile

    - name: 构建项目
      run: bun run build

    - name: 构建输出
      run: ls -la .next

  accessibility:
    name: 可访问性测试
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: 安装依赖
      run: bun install --frozen-lockfile

    - name: 运行可访问性测试
      run: |
        bun run test __tests__/hooks/useAccessibility.test.ts
        bun run test __tests__/components/accessibility/

  performance:
    name: 性能测试
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置 Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: 安装依赖
      run: bun install --frozen-lockfile

    - name: 构建项目
      run: bun run build

    - name: 启动服务器
      run: bun run start &

    - name: 等待服务器启动
      run: sleep 10

    - name: 基础性能测试
      run: |
        curl -f http://localhost:3000 || exit 1
        echo "服务器响应正常"