/**
 * YYC³ AI小语智能成长守护系统 - CI/CD 流水线
 * @file ci.yml
 * @description 完整的持续集成和持续部署流水线配置
 * @author YYC³团队 <admin@0379.email>
 * @version 1.1.0
 */

name: YYC� CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'fix/*', 'feature/*', 'hotfix/*' ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  BUN_VERSION: 'latest'

jobs:
  # �(���
  quality-checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: ${{ env.BUN_VERSION }}

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Type checking
      run: bun run type-check

    - name: Linting
      run: bun run lint

    - name: 依赖安全审计
      run: bun audit --json > security-audit.json || true
    - name: 上传安全审计报告
      uses: actions/upload-artifact@v3
      with:
        name: security-audit-report
        path: security-audit.json
    - name: 代码质量报告生成
      run: bunx eslint --config eslint.config.js --format json > eslint-report.json || true
    - name: 上传代码质量报告
      uses: actions/upload-artifact@v3
      with:
        name: eslint-report
        path: eslint-report.json

  # K�W�
  test-suite:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: quality-checks

    strategy:
      matrix:
        node-version: [18, 20]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'bun'

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: ${{ env.BUN_VERSION }}

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Run unit tests
      run: bun run test

    - name: Run test coverage
      run: bun run test:coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  # �K�
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: quality-checks

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_DB: yyc3_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: ${{ env.BUN_VERSION }}

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Setup test environment
      run: |
        echo "DATABASE_URL=postgresql://postgres:test@localhost:5432/yyc3_test" >> .env.test
        echo "REDIS_URL=redis://localhost:6379" >> .env.test
        echo "NODE_ENV=test" >> .env.test

    - name: Wait for services
      run: |
        sleep 10
        pg_isready -h localhost -p 5432 -U postgres
        redis-cli -h localhost -p 6379 ping

    - name: Run database migrations
      run: bun run db:migrate:test

    - name: Run integration tests
      run: bun run test:integration
      env:
        DATABASE_URL: postgresql://postgres:test@localhost:5432/yyc3_test
        REDIS_URL: redis://localhost:6379

  # ��K�
  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    needs: [test-suite, integration-tests]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: ${{ env.BUN_VERSION }}

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Build application
      run: bun run build:next

    - name: Test production build
      run: |
        bun run start:next &
        sleep 10
        curl -f http://localhost:3000 || exit 1

  # '�K�
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: ${{ env.BUN_VERSION }}

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Install k6
      run: |
        sudo gpg -k /usr/share/keyrings/k6-archive-keyring.gpg --import
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6

    - name: Run performance tests
      run: k6 run --out json=results.json tests/performance/load-test.js

    - name: Upload performance results
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: results.json

  # �r1���
  deployment-ready:
    name: Deployment Ready Check
    runs-on: ubuntu-latest
    needs: [quality-checks, test-suite, integration-tests, build-test]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check version bump
      run: |
        if [ "$(git describe --tags --abbrev=0)" = "$(git describe --tags)" ]; then
          echo "Version bump required for main branch deployment"
          exit 1
        fi

    - name: Generate deployment manifest
      run: |
        echo "DEPLOYMENT_READY=true" >> deployment.env
        echo "BUILD_NUMBER=${{ github.run_number }}" >> deployment.env
        echo "COMMIT_SHA=${{ github.sha }}" >> deployment.env

    - name: Upload deployment manifest
      uses: actions/upload-artifact@v3
      with:
        name: deployment-manifest
        path: deployment.env

  # �
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [quality-checks, test-suite, integration-tests, build-test, deployment-ready]
    if: always()

    steps:
    - name: Notify success
      if: needs.deployment-ready.result == 'success'
      run: |
        echo " All checks passed! Ready for deployment."
        echo "Build: ${{ github.run_number }}"
        echo "Commit: ${{ github.sha }}"

    - name: 发送企业微信通知
      if: always()
      uses: actions-cool/wechat-workflow@v2
      with:
        key: ${{ secrets.WECHAT_WORK_KEY }}
        type: ${{ needs.deployment-ready.result == 'success' ? 'success' : 'failure' }}
        title: 'YYC³ CI/CD 流水线结果通知'
        content: |
          **流水线状态**: ${{ needs.deployment-ready.result == 'success' ? '✅ 成功' : '❌ 失败' }}
          **构建编号**: ${{ github.run_number }}
          **提交信息**: ${{ github.event.commits[0].message }}
          **提交者**: ${{ github.event.commits[0].author.name }}
          **分支**: ${{ github.ref_name }}
          **查看详情**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}